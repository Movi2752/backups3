name: ci-cd

on:
  push:
    branches: [ "main" ]
  workflow_dispatch: {}

jobs:
  deploy:
    runs-on: self-hosted

    defaults:
      run:
        shell: pwsh

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Read compose file
        id: readfile
        run: |
          $content = Get-Content "docker-compose.yml" -Raw
          Add-Content $env:GITHUB_OUTPUT "content<<EOF"
          Add-Content $env:GITHUB_OUTPUT $content
          Add-Content $env:GITHUB_OUTPUT "EOF"
      - name: Deploy stack (Windows PowerShell)
        run: |
            Write-Host "Using path: $env:REMOTE_PATH"
  
            if (!(Test-Path $env:REMOTE_PATH)) {
                New-Item -ItemType Directory -Path $env:REMOTE_PATH | Out-Null
            }
  
            $composeFile = Join-Path $env:REMOTE_PATH "docker-compose.yml"
  
            $content = @"${{ steps.readfile.outputs.content }}"@
  
            Set-Content -Path $composeFile -Value $content -Encoding UTF8
  
            Write-Host "Deploying stack..."
            docker stack deploy -c $composeFile backup
        env:
            REMOTE_PATH: ${{ secrets.REMOTE_PATH }}

