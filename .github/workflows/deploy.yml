name: ci-cd

on:
  push:
    branches: [ "main" ]
  workflow_dispatch: {}

jobs:
  deploy:
    runs-on: self-hosted

    defaults:
      run:
        shell: pwsh

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Deploy stack (Windows PowerShell)
        run: |
          Write-Host "Using path: $env:REMOTE_PATH"

          # создаём директорию, если её нет
          if (!(Test-Path $env:REMOTE_PATH)) {
              New-Item -ItemType Directory -Path $env:REMOTE_PATH | Out-Null
          }

          $composeFile = Join-Path $env:REMOTE_PATH "docker-compose.yml"

          # копируем файл напрямую построчно
          $lines = Get-Content "docker-compose.yml"
          foreach ($line in $lines) {
              Add-Content -Path $composeFile -Value $line
          }

          Write-Host "Deploying stack..."
          docker stack deploy -c $composeFile backup
        env:
            REMOTE_PATH: ${{ secrets.REMOTE_PATH }}
